<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>äººå‹ãƒã‚¹ã‚¯è€ä¹…ã‚²ãƒ¼ãƒ ï¼ˆ3,2,1â†’10ç§’ï¼‰</title>

  <style>
    body { text-align: center; background: #eef; margin: 0; font-family: system-ui, sans-serif; }

    .wrap {
      position: relative; width: 640px; height: 480px; margin: 16px auto;
    }
    /* è¦‹ãŸç›®ã¯é¡è¡¨ç¤ºï¼ˆå·¦å³åè»¢ï¼‰ã«çµ±ä¸€ï¼švideo / mask / canvas ã‚’é‡ã­ã‚‹ */
    /* æ—§: .wrap video, .wrap canvas, .wrap img { transform: scaleX(-1); } */
    .wrap video, .wrap img {
      position: absolute; inset: 0; width: 640px; height: 480px; display: block;
      transform: scaleX(-1);         /* â† é¡ãªã®ã¯æ˜ åƒã¨ãƒã‚¹ã‚¯ã ã‘ */
    }
    .wrap canvas {
      position: absolute; inset: 0; width: 640px; height: 480px; display: block;
      /* â† åè»¢ãªã—ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã¯æ­£å‘ãã®ã¾ã¾æã‘ã‚‹ï¼‰ */
    }
    /* ãƒ¬ã‚¤ãƒ¤é †ï¼švideo(å¥¥) â†’ mask(ä¸­) â†’ canvas(æ‰‹å‰) */
    #overlayMask { z-index: 1; pointer-events: none; }
    #output      { z-index: 2; pointer-events: none; }

    /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆçŠ¶æ…‹ã«å¿œã˜ã¦å‡ºã—å…¥ã‚Œï¼‰ */
    #startBtn {
      display: inline-block; margin: 8px auto; padding: 10px 18px; font-size: 18px;
      border: 0; border-radius: 12px; background: #2b78e4; color: #fff; cursor: pointer;
    }
    #startBtn:disabled { opacity: .6; cursor: not-allowed; }
  </style>

  <!-- MediaPipe CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
</head>
<body>
  <h1>äººå‹ãƒã‚¹ã‚¯è€ä¹…ã‚²ãƒ¼ãƒ </h1>
  <p style="margin:0 0 8px;">æ ã«å½“ãŸã£ãŸã‚‰<strong>OUT</strong>ï¼ 3,2,1ã®ã‚ã¨<strong>10ç§’è€ä¹…</strong>ã ã‚ˆğŸ”¥</p>
  <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

  <div class="wrap">
    <video id="video" autoplay playsinline></video>
    <!-- ğŸ‘‡ ã“ã“ã‚’æ‰‹å…ƒã®ãƒã‚¹ã‚¯ç”»åƒåã«å¤‰æ›´OKï¼ˆä¾‹ï¼šmask_silhouette_T.pngï¼‰ -->
    <img id="overlayMask"
          src="{{ url_for('game_asset', slug='katanuki', asset='mask_silhouette.png') }}"
          alt="mask" />
    <canvas id="output"></canvas>
  </div>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // å‚ç…§ãƒãƒ¼ãƒ‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const startBtn = document.getElementById('startBtn');
    const video    = document.getElementById('video');
    const canvas   = document.getElementById('output');
    const ctx      = canvas.getContext('2d');
    const overlayMask = document.getElementById('overlayMask');

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // è¦‹ãŸç›®ã¨åˆ¤å®šã®æ•´åˆï¼šé¡è¡¨ç¤ºã«ã—ã¦ã‚‹ã®ã§ x åº§æ¨™ã¯ 1-x ã§ç…§åˆ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const MIRRORED = true;

    // é¡”ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    const FACE_IDX = [0,1,2,3,4,5,6,7,8,9,10];

    // å½“ãŸã‚Šåˆ¤å®šã«ä½¿ã†ä¸»è¦ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¢—æ¸›OKï¼‰
    const CHECK_POINTS = [0,11,12,13,14,15,16,23,24,25,26,27,28];

    // ãƒã‚¹ã‚¯ã®ä¸é€æ˜é–¾å€¤ï¼ˆÎ±>=ã“ã®å€¤â†’ãƒ–ãƒ­ãƒƒã‚¯é ˜åŸŸï¼æ /å¤–å´ï¼‰
    const ALPHA_TH = 10;

    // ã€Œæ ã«è§¦ã‚ŒãŸã€æ‰±ã„ã®åŠå¾„ï¼ˆpxï¼‰ï¼† ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°é–“éš”
    const CHECK_RADIUS_PX = 6;
    const STEP_PX = 2;

    // ç·šãƒ»ç‚¹ã®è‰²ï¼ˆSAFEæ™‚ï¼‰ã¨ OUTæ™‚ã®ç·šè‰²
    const CONNECTOR_COLOR_SAFE = '#00B3FF';
    const CONNECTOR_COLOR_OUT  = '#FF2D2D'; // â† å½“ãŸã£ã¦ãŸã‚‰ã“ã®èµ¤ã«
    const LANDMARK_COLOR       = '#FFD400';

    // ã‚²ãƒ¼ãƒ è¨­å®šï¼šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç§’æ•° / æœ¬ç·¨ã®è€ä¹…ç§’æ•°
    const COUNTDOWN_SEC = 3;
    const DURATION_SEC  = 10;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ãƒã‚¹ã‚¯ç”»åƒã®ãƒ”ã‚¯ã‚»ãƒ«å‚ç…§ï¼ˆã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const maskCanvas = document.createElement('canvas');
    const maskCtx    = maskCanvas.getContext('2d');
    let maskReady = false, maskW = 0, maskH = 0, maskImageData = null;

    overlayMask.addEventListener('load', () => {
      maskW = maskCanvas.width  = overlayMask.naturalWidth  || 640;
      maskH = maskCanvas.height = overlayMask.naturalHeight || 480;
      maskCtx.clearRect(0,0,maskW,maskH);
      maskCtx.drawImage(overlayMask, 0, 0, maskW, maskH);
      maskImageData = maskCtx.getImageData(0, 0, maskW, maskH).data;
      maskReady = true;
      // ãƒã‚¹ã‚¯èª­ã¿è¾¼ã¿å®Œäº†ã¾ã§ã¯é–‹å§‹ä¸å¯ã«ã—ã¨ãï¼ˆã‚ºãƒ¬é˜²æ­¢ï¼‰
      startBtn.disabled = false;
    });

    // åˆæœŸã¯ãƒã‚¹ã‚¯æœªèª­è¾¼ãªã®ã§ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ï¼ˆç”»åƒèª­ã¿è¾¼ã¿ã§è§£é™¤ï¼‰
    startBtn.disabled = true;

    function isBlockedPixel(x, y) {
      if (x < 0 || y < 0 || x >= maskW || y >= maskH) return true; // ç”»é¢å¤–ã¯ãƒ–ãƒ­ãƒƒã‚¯æ‰±ã„
      const idx = (Math.floor(y) * maskW + Math.floor(x)) * 4;
      const alpha = maskImageData[idx + 3];
      return alpha >= ALPHA_TH; // ä¸é€æ˜ï¼æ /å¤–å´ï¼ˆNGï¼‰
    }

    function hitFrameAround(x, y, r = CHECK_RADIUS_PX, step = STEP_PX) {
      for (let dy = -r; dy <= r; dy += step) {
        for (let dx = -r; dx <= r; dx += step) {
          if (dx*dx + dy*dy > r*r) continue; // å††é ˜åŸŸå†…ã®ã¿
          if (isBlockedPixel(x + dx, y + dy)) return true;
        }
      }
      return false;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ï¼ˆidle â†’ countdown â†’ playing â†’ finishedï¼‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let gameState = 'idle';
    let tCountdownStart = 0; // performance.now() ã®å€¤ï¼ˆmsï¼‰
    let tGameStart      = 0;
    let survivedSec     = 0;
    let resultText      = ''; // "CLEAR!" or "GAME OVER"

    function nowSec() { return performance.now() / 1000; }

    function setState(next) {
      gameState = next;
      if (next === 'idle') {
        startBtn.style.display = 'inline-block';
        startBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
      }
      if (next === 'countdown') {
        startBtn.style.display = 'none';
        tCountdownStart = nowSec();
      }
      if (next === 'playing') {
        tGameStart = nowSec();
        survivedSec = 0;
      }
      if (next === 'finished') {
        startBtn.style.display = 'inline-block';
        startBtn.textContent = 'ã‚‚ã†ä¸€åº¦';
      }
    }

    startBtn.addEventListener('click', () => {
      if (!maskReady) return; // å¿µã®ãŸã‚
      if (gameState === 'idle' || gameState === 'finished') {
        setState('countdown');
      }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // MediaPipe Pose è¨­å®š
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const pose = new Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });
    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    pose.onResults(results => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!results.poseLandmarks) return;

      const lm = results.poseLandmarks;

      // 1) ãƒã‚¹ã‚¯å½“ãŸã‚Šåˆ¤å®šï¼šä¸»è¦ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã®è¿‘å‚ãŒä¸é€æ˜ãªã‚‰ OUT
      let isOut = false;
      if (maskReady) {
        for (const i of CHECK_POINTS) {
          const p = lm[i];
          if (!p) continue;
          if (p.visibility !== undefined && p.visibility < 0.4) continue;

          let x = p.x, y = p.y;
          if (MIRRORED) x = 1 - x;  // é¡è¡¨ç¤ºã®è¦‹ãŸç›®ã«åˆã‚ã›ã‚‹
          const px = x * maskW;
          const py = y * maskH;

          if (hitFrameAround(px, py)) { isOut = true; break; }
        }
      }

      // 2) ã‚²ãƒ¼ãƒ é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯
      const tNow = nowSec();

      if (gameState === 'countdown') {
        const elapsed = tNow - tCountdownStart;
        const remain  = Math.ceil(COUNTDOWN_SEC - elapsed);
        // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºï¼ˆ3,2,1 â†’ START!ï¼‰
        ctx.save();
        ctx.font = "bold 96px system-ui, sans-serif";
        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.textAlign = "center";
        ctx.fillText(remain > 0 ? remain : "START!", canvas.width/2, 150);
        ctx.restore();

        if (elapsed >= COUNTDOWN_SEC) {
          setState('playing');
        }
      }

      if (gameState === 'playing') {
        survivedSec = Math.max(0, tNow - tGameStart);

        // å½“ãŸã£ãŸã‚‰å³çµ‚äº†
        if (isOut) {
          resultText = "GAME OVER";
          setState('finished');
        }
        // 10ç§’å®Œèµ°ã§ã‚¯ãƒªã‚¢
        else if (survivedSec >= DURATION_SEC) {
          survivedSec = DURATION_SEC;
          resultText = "CLEAR!";
          setState('finished');
        }

        // æ®‹ã‚Šæ™‚é–“è¡¨ç¤º
        const remain = Math.max(0, DURATION_SEC - survivedSec);
        ctx.save();
        ctx.font = "bold 28px system-ui, sans-serif";
        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.fillText(`æ®‹ã‚Š ${remain.toFixed(1)} ç§’`, 20, 36);
        ctx.restore();
      }

      if (gameState === 'finished') {
        // ãƒªã‚¶ãƒ«ãƒˆè¡¨ç¤º
        ctx.save();
        ctx.font = "bold 64px system-ui, sans-serif";
        ctx.fillStyle = resultText === "CLEAR!" ? "rgba(0,200,0,0.95)" : "rgba(255,0,0,0.95)";
        ctx.textAlign = "center";
        ctx.fillText(resultText, canvas.width/2, 120);
        ctx.font = "bold 24px system-ui, sans-serif";
        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.fillText(`ç”Ÿå­˜ã‚¿ã‚¤ãƒ ï¼š${survivedSec.toFixed(2)} ç§’`, canvas.width/2, 160);
        ctx.fillText("ãƒœã‚¿ãƒ³ã§ãƒªãƒˆãƒ©ã‚¤", canvas.width/2, 192);
        ctx.restore();
      }

      // 3) éª¨æ ¼æç”»ï¼šå½“ãŸã£ã¦ãŸã‚‰ç·šï¼ˆã‚³ãƒã‚¯ã‚¿ï¼‰ã‚’èµ¤ã«ã™ã‚‹
      const landmarksNoFace = lm.map((p, idx) => FACE_IDX.includes(idx) ? null : p);
      const connectionsNoFace = POSE_CONNECTIONS.filter(([a,b]) =>
        !FACE_IDX.includes(a) && !FACE_IDX.includes(b)
      );

      const connectorColor = isOut ? CONNECTOR_COLOR_OUT : CONNECTOR_COLOR_SAFE;
      
      // â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šæç”»ç”¨ã«â€œã ã‘â€å·¦å³åè»¢ã—ãŸåº§æ¨™ã‚’ä½œã‚‹
      const drawLm = MIRRORED
        ? landmarksNoFace.map(p => p ? ({ ...p, x: 1 - p.x }) : null)
        : landmarksNoFace;
      // åè»¢ãªã—ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ã€åè»¢æ¸ˆã¿åº§æ¨™ã‚’ä¸€åº¦ã ã‘æç”»
      drawConnectors(ctx, drawLm, connectionsNoFace, { color: connectorColor, lineWidth: 3 });
      drawLandmarks(ctx, drawLm.filter(Boolean), { color: LANDMARK_COLOR, lineWidth: 2 });

      // 4) è£œåŠ©ï¼šã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ã®ç°¡æ˜“ãƒ˜ãƒ«ãƒ—
      if (gameState === 'idle') {
        ctx.save();
        ctx.font = "bold 20px system-ui, sans-serif";
        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.fillText("äººå‹ã®é€æ˜éƒ¨åˆ†ã«ä½“ã‚’å…¥ã‚Œã¦ã­", 16, 32);
        ctx.restore();
      }
    });

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    const camera = new Camera(video, {
      onFrame: async () => { await pose.send({ image: video }); },
      width: 640, height: 480
    });
    camera.start();

    // åˆæœŸçŠ¶æ…‹ã¸
    setState('idle');
  </script>
</body>
</html>
