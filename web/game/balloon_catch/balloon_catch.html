<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ‰‹ã‚­ãƒ£ãƒƒãƒã‚²ãƒ¼ãƒ  - é¢¨èˆ¹ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin: 0; background:#f5f7fb; display:grid; place-items:center; min-height:100vh; }
    .wrap { position: relative; width: 640px; height: 480px; }
    video, canvas { position: absolute; inset: 0; width: 640px; height: 480px; }
    video { display:none; }
    #score {
      position: absolute; left: 10px; top: 10px;
      padding: 6px 10px; background: rgba(0,0,0,.5); color: #fff; border-radius: 8px;
      font: 600 16px/1.2 system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    }
    #timer{
      position:absolute; right:10px; top:10px;
      padding:6px 10px; background:rgba(0,0,0,.5); color:#fff; border-radius:8px;
      font:600 16px/1.2 system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
    }
    #overlay.hidden { display: none; }
    #overlay{
      position:absolute; inset:0; display:grid; place-items:center; text-align:center;
      font-weight:800; font-size:72px; color:#fff; background:rgba(0,0,0,.35); padding:16px;
    }
    .hidden{ display:none; }

    /* å§‹ã‚ã®ç”»é¢ã®è£…é£¾ */
    #overlay .lead {
      font-size: 24px;
      font-weight: 700;
      line-height: 1.6;
      margin-bottom: 16px;
    }


    /* FINISHç”»é¢ã®è£…é£¾ */
    #overlay .finish { font-size: 64px; margin-bottom: 8px; }
    #overlay .score  { font-size: 24px; font-weight: 700; margin-bottom: 16px; }
    #overlay .actions { display: flex; gap: 12px; justify-content: center; }
    #overlay .actions button {
      font-size: 18px; padding: 10px 16px; border: none; border-radius: 10px;
      background: #2563eb; color: #fff; cursor: pointer;
    }
    #overlay .actions button#exitBtn { background: #6b7280; }


  </style>
  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>
  <div class="wrap">
    <video id="video" playsinline></video>
    <canvas id="canvas"></canvas>
    <div id="score">ã‚¹ã‚³ã‚¢: 0</div>
    <div id="timer">10.0</div>
    <div id="overlay" class="hidden"></div>
  </div>

  <script>
    // ====== DOM ======
    const video  = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx    = canvas.getContext('2d');
    const scoreEl= document.getElementById('score');
    const timerEl= document.getElementById('timer');
    const overlayEl= document.getElementById('overlay');
    canvas.width = 640; canvas.height = 480;

    // ====== å§‹ã‚ã®ç”»é¢ ======
    function showTitle() {
      overlayEl.innerHTML = `
        <div class="lead">ä¸Šã‹ã‚‰è½ã¡ã¦ãã‚‹é¢¨èˆ¹ğŸˆã‚’æ‰‹ã‚’ä½¿ã£ã¦ã‚­ãƒ£ãƒƒãƒã—ã‚ˆã†ï¼ï¼</div>
        <div class="actions">
          <button id="startBtn">å§‹ã‚ã‚‹</button>
        </div>
      `;
      overlayEl.classList.remove('hidden');
    }


    // ãƒ«ãƒ¼ãƒ—IDï¼ˆçµ‚äº†æ™‚ã«æ­¢ã‚ã‚‹ç”¨ï¼‰
    let rafId = null;

    // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯æ¯å›innerHTMLã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã®ã§å§”è­²ã§æ‹¾ã†ï¼‰
    overlayEl.addEventListener('click', (e) => {
      const id = e.target?.id;
      if (id === 'startBtn') {
        overlayEl.classList.add('hidden');
        startGame();
      } else if (id === 'restartBtn') {
        overlayEl.classList.add('hidden');
        startGame();
      } else if (id === 'exitBtn') {
        endGame();
      }
    });


    // ====== åŠ¹æœéŸ³ï¼ˆã‚¿ãƒƒãƒ—è§£ç¦ã¯ã—ãªã„ã€‚å¤±æ•—ã—ã¦ã‚‚æ¡ã‚Šã¤ã¶ã™ï¼‰======
    const catchSound = new Audio("/game/balloon_catch/catch.mp3");
    catchSound.preload = "auto";
    catchSound.volume = 1.0;
    async function playCatch() {
      try {
        catchSound.currentTime = 0;
        await catchSound.play();
      } catch (e) { /* ãƒ¢ãƒã‚¤ãƒ«ã¯NotAllowedErrorã«ãªã£ã¦ã‚‚OK */ }
    }

    // ====== ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç† ======
    let state = 'title';          // 'title' | 'countdown' | 'playing' | 'gameover'
    const GAME_DURATION = 10;     // ç§’
    const START_HOLD_MS = 600;    // START! ã‚’è¦‹ã›ã‚‹æ™‚é–“
    let timeLeft = GAME_DURATION;
    let countdownMs = 3000;
    let startHoldMs = START_HOLD_MS;
    let lastTs = null;

    // ====== é¢¨èˆ¹ç”»åƒ ======
    const balloonImg = new Image();
    balloonImg.src = "/game/balloon_catch/balloon.png";
    let balloonReady = false;
    balloonImg.onload = () => { balloonReady = true; };

    // ====== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ======
    let score = 0;
    const HAND_VIS_RADIUS = 12;
    let handCenters = [];
    const ball = { x: 320, y: -30, r: 24, vy: 3.2 };

    function resetBall() {
      ball.x  = Math.random() * canvas.width;
      ball.y  = -30;
      ball.vy = 3 + Math.random() * 2.5;
    }

    function startGame(){
      score = 0;
      scoreEl.textContent = `ã‚¹ã‚³ã‚¢: ${score}`;
      timeLeft = GAME_DURATION;
      timerEl.textContent = timeLeft.toFixed(1);
      countdownMs = 3000;
      startHoldMs = START_HOLD_MS;
      state = 'countdown';
      overlayEl.classList.remove('hidden');
      overlayEl.textContent = '3';
      resetBall();
    }

    // ====== MediaPipe Hands ======
    function onResults(results) {
      handCenters = [];
      if (results.multiHandLandmarks && results.multiHandLandmarks.length) {
        for (const lm of results.multiHandLandmarks) {
          const cx = ((lm[0].x + lm[5].x + lm[17].x) / 3) * canvas.width;
          const cy = ((lm[0].y + lm[5].y + lm[17].y) / 3) * canvas.height;
          handCenters.push({ x: cx, y: cy });
        }
      }
    }
    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
    });
    hands.setOptions({
      maxNumHands: 2,
      modelComplexity: 1,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.5,
    });
    hands.onResults(onResults);

    const camera = new Camera(video, {
      onFrame: async () => { await hands.send({ image: video }); },
      width: 640, height: 480,
    });
    camera.start();

    // ====== ãƒ«ãƒ¼ãƒ— ======
    function update(ts){
      if (typeof ts !== 'number') ts = performance.now();
      if (lastTs === null) lastTs = ts;
      const dt = (ts - lastTs) / 1000;
      lastTs = ts;

      // èƒŒæ™¯ï¼ˆãƒŸãƒ©ãƒ¼ï¼‰
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      try { ctx.drawImage(video, 0, 0, canvas.width, canvas.height); } catch(e){}
      ctx.restore();

      // é¢¨èˆ¹æç”» & å½“ãŸã‚Šåˆ¤å®šåŠå¾„
      let effR = ball.r;
      if (balloonReady) {
        const targetH = Math.max(70, Math.min(110, ball.r * 3.2));
        const ratio   = (balloonImg.naturalWidth || 1) / (balloonImg.naturalHeight || 1);
        const targetW = targetH * ratio;
        ctx.drawImage(balloonImg, ball.x - targetW/2, ball.y - targetH/2, targetW, targetH);
        effR = Math.max(targetW, targetH) * 0.45;
      } else {
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
        ctx.fillStyle = '#4aa3ff'; ctx.fill();
        ctx.lineWidth = 3; ctx.strokeStyle = '#1f5fbf'; ctx.stroke();
        effR = ball.r;
      }

      // æ‰‹ï¼ˆèµ¤ä¸¸ãƒ»ãƒŸãƒ©ãƒ¼ï¼‰
      for (const p of handCenters) {
        const mx = canvas.width - p.x;
        ctx.beginPath();
        ctx.arc(mx, p.y, HAND_VIS_RADIUS, 0, Math.PI * 2);
        ctx.fillStyle = 'red';
        ctx.fill();
      }

      // ã‚¹ãƒ†ãƒ¼ãƒˆ
      if (state === 'title') {
      // ã‚¿ã‚¤ãƒˆãƒ«ä¸­ã¯ä½•ã‚‚ã—ãªã„ï¼ˆèƒŒæ™¯ã ã‘æ˜ ã™ï¼é¢¨èˆ¹ã‚‚è½ã¨ã•ãªã„ï¼‰
      // å¿…è¦ãªã‚‰ã“ã“ã§æ¼”å‡ºã‚’æ›¸ã
    }
    else if (state === 'countdown') {
      // ï¼ˆæ—¢å­˜ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å‡¦ç†ãã®ã¾ã¾ï¼‰
      countdownMs -= dt * 1000;
      if (countdownMs > 0) {
        const left = Math.ceil(countdownMs / 1000);
        overlayEl.classList.remove('hidden');
        overlayEl.textContent = String(left);
      } else {
        overlayEl.classList.remove('hidden');
        overlayEl.textContent = 'START!';
        startHoldMs -= dt * 1000;
        if (startHoldMs <= 0) {
          overlayEl.classList.add('hidden');
          state = 'playing';
        }
      }
      } else if (state === 'playing') {
        // ã‚¿ã‚¤ãƒãƒ¼
        timeLeft -= dt;
        if (timeLeft < 0) timeLeft = 0;
        timerEl.textContent = timeLeft.toFixed(1);

        // è½ä¸‹
        ball.y += ball.vy;

        // å½“ãŸã‚Šåˆ¤å®šï¼ˆãƒŸãƒ©ãƒ¼åº§æ¨™ï¼‰
        for (const p of handCenters) {
          const mx = canvas.width - p.x;
          const dx = ball.x - mx;
          const dy = ball.y - p.y;
          const dist = Math.hypot(dx, dy);
          if (dist <= effR + HAND_VIS_RADIUS) {
            score++;
            scoreEl.textContent = `ã‚¹ã‚³ã‚¢: ${score}`;
            playCatch();
            resetBall();
            break;
          }
        else if (state === 'gameover') {
        // ï¼ˆFINISH ã§ãƒœã‚¿ãƒ³å¾…ã¡ï¼šä½•ã‚‚ã—ãªã„ï¼‰
      }
    }

        // ç”»é¢å¤–
        if (ball.y - effR > canvas.height) resetBall();

        // çµ‚äº†
        // æ™‚é–“åˆ‡ã‚Œâ†’ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
        if (timeLeft <= 0) {
          state = 'gameover';
          overlayEl.innerHTML = `
            <div class="finish">FINISH</div>
            <div class="score">ã‚¹ã‚³ã‚¢: ${score}</div>
            <div class="actions">
              <button id="restartBtn">ã‚‚ã†ä¸€åº¦</button>
              <button id="exitBtn">çµ‚ã‚ã‚‹</button>
            </div>`;
          overlayEl.classList.remove('hidden');
        }
      }

      rafId = requestAnimationFrame(update);
    }

    function endGame(){
  // æç”»ãƒ«ãƒ¼ãƒ—åœæ­¢
  if (rafId) cancelAnimationFrame(rafId);
  rafId = null;

  // ã‚«ãƒ¡ãƒ©åœæ­¢ï¼ˆå–ã‚Œãªã„ç’°å¢ƒã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã‚¬ãƒ¼ãƒ‰ï¼‰
  try {
    const tracks = video.srcObject?.getTracks?.();
    if (tracks) tracks.forEach(t => t.stop());
  } catch (e) {}

  // æœ€çµ‚è¡¨ç¤ºï¼ˆä»»æ„ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å·®ã—æ›¿ãˆï¼‰
  overlayEl.innerHTML = `
    <div class="finish">FINISH</div>
    <div class="score">ã‚¹ã‚³ã‚¢: ${score}</div>
    <div style="font-size:20px; margin-top:8px;">ãŠã¤ã‹ã‚Œã•ã¾ï¼</div>
  `;
  overlayEl.classList.remove('hidden');
  state = 'ended'; // ä»¥å¾Œã¯ä½•ã‚‚ã—ãªã„
}

showTitle();                  // â† ã¾ãšã‚¿ã‚¤ãƒˆãƒ«ã‚’å‡ºã™
rafId = requestAnimationFrame(update);

  </script>
</body>
</html>
